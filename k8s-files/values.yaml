# Comprehensive values.yaml for Weaviate Server + Hypha Startup Services
# This deploys everything in a single pod for localhost connectivity

# Global configuration
global:
  nameOverride: "hypha-weaviate-stack"
  fullnameOverride: "hypha-weaviate-stack"

# Main deployment configuration
deployment:
  replicaCount: 1

  # Pod-level configuration
  podSecurityContext:
    seccompProfile:
      type: RuntimeDefault

  # Service account
  serviceAccount:
    create: true
    automount: true
    name: "hypha-weaviate-stack"
    annotations: {}

  # Image pull secrets
  imagePullSecrets:
    - name: ghcr-secret

  # Node selector, tolerations, affinity
  nodeSelector: {}
  tolerations: []
  affinity: {}

# Container configurations
containers:
  # Weaviate Database Server
  weaviate:
    enabled: true
    image:
      registry: cr.weaviate.io
      repository: semitechnologies/weaviate
      tag: "1.29.0"
      pullPolicy: IfNotPresent

    ports:
      - name: http
        containerPort: 8080
        protocol: TCP
      - name: grpc
        containerPort: 50051
        protocol: TCP

    env:
      # Basic Weaviate configuration
      - name: QUERY_DEFAULTS_LIMIT
        value: "25"
      - name: AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED
        value: "true"
      - name: PERSISTENCE_DATA_PATH
        value: "/var/lib/weaviate"
      - name: DEFAULT_VECTORIZER_MODULE
        value: "text2vec-ollama"
      - name: ENABLE_MODULES
        value: "text2vec-ollama,generative-ollama,backup-s3,offload-s3"

      # S3 backup configuration
      - name: BACKUP_S3_BUCKET
        value: "hypha-weaviate-backups"
      - name: BACKUP_S3_ENDPOINT
        value: "s3.cloud.kth.se"
      - name: BACKUP_S3_USE_SSL
        value: "true"

      # S3 offload configuration
      - name: OFFLOAD_S3_BUCKET
        value: "hypha-weaviate-offload"
      - name: OFFLOAD_S3_ENDPOINT
        value: "s3.cloud.kth.se"
      - name: OFFLOAD_S3_USE_SSL
        value: "true"

      # AWS credentials
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: hypha-secrets
            key: ACCESS_KEY_ID
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: hypha-secrets
            key: SECRET_ACCESS_KEY

    securityContext:
      runAsUser: 1001
      runAsGroup: 1001
      capabilities:
        drop:
          - ALL
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      privileged: false
      readOnlyRootFilesystem: true

    resources:
      limits:
        cpu: 2000m
        memory: 4Gi
      requests:
        cpu: 500m
        memory: 1Gi

    # Persistent storage for Weaviate data
    volumeMounts:
      - name: weaviate-data
        mountPath: /var/lib/weaviate
      - name: tmp
        mountPath: /tmp

    # Health checks
    livenessProbe:
      httpGet:
        path: /v1/.well-known/live
        port: 8080
      initialDelaySeconds: 120
      periodSeconds: 30
      timeoutSeconds: 10

    readinessProbe:
      httpGet:
        path: /v1/.well-known/ready
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5

  # Hypha Startup Services (both weaviate and mem0)
  startup-services:
    enabled: true
    image:
      repository: ghcr.io/aicell-lab/hypha-startup-services
      tag: "latest"
      pullPolicy: Always

    # Use the startup script to run both services
    command: ["/app/start-services.sh"]

    env:
      # Hypha connection
      - name: HYPHA_TOKEN
        valueFrom:
          secretKeyRef:
            name: aria-agents-secrets
            key: ARIA_AGENTS_TOKEN

      # Service configuration
      - name: SERVER_URL
        value: "https://hypha.aicell.io"
      - name: WEAVIATE_SERVICE_ID
        value: "weaviate-production"
      - name: MEM0_SERVICE_ID
        value: "mem0-production"

      # Mem0 configuration (if needed)
      - name: MEM0_API_KEY
        valueFrom:
          secretKeyRef:
            name: aria-agents-secrets
            key: MEM0_API_KEY
            optional: true

    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000

    resources:
      limits:
        cpu: 1000m
        memory: 1Gi
      requests:
        cpu: 200m
        memory: 256Mi

    # Health checks
    livenessProbe:
      exec:
        command:
          - /bin/sh
          - -c
          - "pgrep -f 'hypha-startup-services'"
      initialDelaySeconds: 60
      periodSeconds: 30
      timeoutSeconds: 10

    readinessProbe:
      exec:
        command:
          - /bin/sh
          - -c
          - "pgrep -f 'hypha-startup-services'"
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5

# Volume configuration
volumes:
  - name: weaviate-data
    persistentVolumeClaim:
      claimName: weaviate-data-pvc
  - name: tmp
    emptyDir: {}

# Persistent Volume Claim for Weaviate data
persistentVolumeClaim:
  enabled: true
  name: weaviate-data-pvc
  storageClass: "" # Use default storage class
  accessMode: ReadWriteOnce
  size: 50Gi

# Service configuration
service:
  enabled: true
  type: ClusterIP
  ports:
    - name: weaviate-http
      port: 8080
      targetPort: 8080
      protocol: TCP
    - name: weaviate-grpc
      port: 50051
      targetPort: 50051
      protocol: TCP

# Ingress configuration (optional)
ingress:
  enabled: false
  className: ""
  annotations: {}
  hosts:
    - host: weaviate.local
      paths:
        - path: /
          pathType: Prefix
  tls: []

# Testing endpoints
testing:
  enabled: true
  endpoints:
    weaviate_server: "http://localhost:8080/v1/.well-known/ready"
    weaviate_service: "https://hypha.aicell.io/aria-agents/services/weaviate-production"
    mem0_service: "https://hypha.aicell.io/aria-agents/services/mem0-production"

# Autoscaling (disabled for single-pod setup)
autoscaling:
  enabled: false

# Resource monitoring
monitoring:
  enabled: false
