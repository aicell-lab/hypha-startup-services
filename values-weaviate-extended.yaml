# Simplified values.yaml for adding hypha startup services to existing Weaviate deployment
# This extends the Weaviate Helm chart with additional startup service deployments

# Weaviate server configuration (from original values.yaml)
image:
  registry: cr.weaviate.io
  tag: 1.29.0
  repo: semitechnologies/weaviate
  pullPolicy: IfNotPresent
  pullSecrets: []

initContainers:
  sysctlInitContainer:
    enabled: false
  ensureFileOwnershipContainer:
    enabled: false

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  runAsNonRoot: true
  runAsUser: 1001
  seccompProfile:
    type: RuntimeDefault

containerSecurityContext:
  runAsUser: 1001
  runAsGroup: 1001
  capabilities:
    drop:
      - ALL
  runAsNonRoot: true
  allowPrivilegeEscalation: false
  privileged: false
  readOnlyRootFilesystem: true

aws:
  secretName: hypha-secrets
  accessKeyIdKey: ACCESS_KEY_ID
  secretAccessKeyKey: SECRET_ACCESS_KEY

offload:
  s3:
    enabled: true
    envconfig:
      OFFLOAD_S3_BUCKET: hypha-weaviate-offload
      OFFLOAD_S3_ENDPOINT: s3.cloud.kth.se
      OFFLOAD_S3_USE_SSL: true

backups:
  filesystem:
    enabled: false
    envconfig:
      BACKUP_FILESYSTEM_PATH: /tmp/backups
  s3:
    enabled: true
    envconfig:
      BACKUP_S3_BUCKET: hypha-weaviate-backups
      BACKUP_S3_ENDPOINT: s3.cloud.kth.se
      BACKUP_S3_USE_SSL: true
  gcs:
    enabled: false
    envconfig:
      BACKUP_GCS_BUCKET: hypha-weaviate-backups
  azure:
    enabled: false
    envconfig:
      BACKUP_AZURE_CONTAINER: hypha-weaviate-backups

modules:
  text2vec-ollama:
    enabled: true
  generative-ollama:
    enabled: true
  text2vec-contextionary:
    enabled: false
  text2vec-transformers:
    enabled: false
  text2vec-openai:
    enabled: false
  text2vec-cohere:
    enabled: false
  text2vec-huggingface:
    enabled: false
  text2vec-palm:
    enabled: false
  text2vec-gpt4all:
    enabled: false
  text-spellcheck:
    enabled: false

ingress:
  enabled: false

grpcService:
  enabled: true
  name: weaviate-grpc
  ports:
    - name: grpc
      protocol: TCP
      port: 50051
  type: ClusterIP

# Additional deployments for hypha startup services
# These will be created as separate deployments alongside Weaviate
additionalDeployments:
  # Weaviate startup service
  weaviate-service:
    enabled: true
    replicaCount: 1

    image:
      repository: ghcr.io/aicell-lab/hypha-startup-services
      pullPolicy: Always
      tag: "latest" # Update to specific version when available

    imagePullSecrets:
      - name: ghcr-secret

    serviceAccount:
      create: true
      name: weaviate-startup-service

    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000

    podSecurityContext:
      seccompProfile:
        type: RuntimeDefault

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi

    env:
      - name: HYPHA_TOKEN
        valueFrom:
          secretKeyRef:
            name: aria-agents-secrets
            key: ARIA_AGENTS_TOKEN

    # Command to run weaviate service
    command: ["hypha-startup-services", "weaviate", "remote"]
    args:
      - "--server-url=https://hypha.aicell.io"
      - "--service-id=weaviate-production"

  # Mem0 startup service
  mem0-service:
    enabled: true
    replicaCount: 1

    image:
      repository: ghcr.io/aicell-lab/hypha-startup-services
      pullPolicy: Always
      tag: "latest" # Update to specific version when available

    imagePullSecrets:
      - name: ghcr-secret

    serviceAccount:
      create: true
      name: mem0-startup-service

    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000

    podSecurityContext:
      seccompProfile:
        type: RuntimeDefault

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi

    env:
      - name: HYPHA_TOKEN
        valueFrom:
          secretKeyRef:
            name: aria-agents-secrets
            key: ARIA_AGENTS_TOKEN
      # Add mem0 specific environment variables if needed
      - name: MEM0_API_KEY
        valueFrom:
          secretKeyRef:
            name: aria-agents-secrets
            key: MEM0_API_KEY
            optional: true

    # Command to run mem0 service
    command: ["hypha-startup-services", "mem0", "remote"]
    args:
      - "--server-url=https://hypha.aicell.io"
      - "--service-id=mem0-production"
